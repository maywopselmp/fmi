<!DOCTYPE html>
<html>
<head>
  <title>2FA + CAPTCHA Solver</title>
  <!-- Firebase SDK for real-time updates -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <h1>2FA Verification</h1>
  <h2>Enter OTP</h2>
  <input type="text" id="otp" placeholder="Enter OTP">
  <button onclick="verifyOTP()">Verify</button>
  <h2>CAPTCHA Solver</h2>
  <div id="captchaContainer"></div>
  <div id="statusMessage"></div>
  <button id="logoutButton" style="display: none;" onclick="logout()">Logout</button>
  <script>
    // Initialize Firebase
    const firebaseConfig = {}; // Placeholder replaced by build.js
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let sessionId = "session-abc123"; // Replace with actual session ID (e.g., generated dynamically)
    let userId = "user123"; // Replace with actual user ID (e.g., from Netlify Identity)

    // Verify the OTP
    function verifyOTP() {
      const otp = document.getElementById("otp").value;

      fetch("/api/verify-otp", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-session-id": sessionId,
        },
        body: JSON.stringify({ token: otp }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("OTP verified successfully!");
            // Enable CAPTCHA solving
            document.getElementById("logoutButton").style.display = "block";
            document.getElementById("statusMessage").textContent =
              "You can now solve CAPTCHAs.";
            startListeningForCaptchas();
          } else {
            alert(data.message || "Invalid OTP. Please try again.");
          }
        })
        .catch((error) => {
          console.error("Error verifying OTP:", error);
          alert("An error occurred while verifying OTP. Please try again.");
        });
    }

    // Start listening for new CAPTCHAs
    function startListeningForCaptchas() {
      database.ref('captchas')
        .orderByChild('status')
        .equalTo('pending')
        .on('child_added', (snapshot) => {
          const captchaId = snapshot.key;
          const captchaData = snapshot.val();
          displayCaptcha(captchaId, captchaData);
        });
    }

    // Display and solve CAPTCHA
    function displayCaptcha(captchaId, data) {
      document.getElementById('statusMessage').textContent = 'New mission detected!';
      const script = document.createElement('script');
      script.src = `https://${data.api_server}/geetest.js?gt=${data.gt}&challenge=${data.challenge}`;
      document.head.appendChild(script);
      script.onload = () => {
        initGeetest({
          gt: data.gt,
          challenge: data.challenge,
          offline: false,
          new_captcha: true,
        }, (captcha) => {
          document.getElementById('captchaContainer').innerHTML = '';
          captcha.appendTo('#captchaContainer');
          captcha.onSuccess(() => {
            const solution = captcha.getValidate();
            // Update CAPTCHA status to solved
            database.ref(`captchas/${captchaId}`).update({
              solution,
              status: 'solved',
              solvedAt: firebase.database.ServerValue.TIMESTAMP,
            }).then(() => {
              document.getElementById('statusMessage').textContent = 'Mission solved! Checking for more...';
              setTimeout(() => {
                document.getElementById('captchaContainer').innerHTML = '';
                document.getElementById('statusMessage').textContent = 'Waiting for new missions...';
              }, 3000);
            });
          });
        });
      };
    }

    // Logout Functionality
    function logout() {
      fetch("/api/logout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-session-id": sessionId,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert("Logged out successfully. New API key generated for the next session.");
            // Clear the encrypted API key and hide the logout button
            document.getElementById("logoutButton").style.display = "none";
            document.getElementById("statusMessage").textContent =
              "You have been logged out. Please log in again.";
          } else {
            alert(data.message || "Failed to log out. Please try again.");
          }
        })
        .catch((error) => {
          console.error("Error logging out:", error);
          alert("An error occurred while logging out. Please try again.");
        });
    }
  </script>
</body>
</html>
